<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dataengine.datamanagement.infrastructure.persistence.mapper.DatasetFileMapper">

    <resultMap id="DatasetFileResultMap" type="com.dataengine.datamanagement.domain.model.dataset.DatasetFile">
        <id column="id" property="id"/>
        <result column="dataset_id" property="datasetId"/>
        <result column="file_name" property="fileName"/>
        <result column="file_path" property="filePath"/>
        <result column="file_type" property="fileType"/>
        <result column="file_format" property="fileFormat"/>
        <result column="file_size" property="fileSize"/>
        <result column="upload_time" property="uploadTime"/>
        <result column="last_access_time" property="lastAccessTime"/>
        <result column="status" property="status"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, dataset_id, file_name, file_path, file_type, file_format, file_size, upload_time, last_access_time, status
    </sql>

    <select id="findById" parameterType="string" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE id = #{id}
    </select>

    <select id="findByDatasetId" parameterType="string" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId}
        ORDER BY upload_time DESC
    </select>

    <select id="findByDatasetIdAndStatus" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId}
          AND status = #{status}
        ORDER BY upload_time DESC
    </select>

    <select id="findByDatasetIdAndFileType" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId}
          AND file_type = #{fileType}
        ORDER BY upload_time DESC
    </select>

    <select id="countByDatasetId" parameterType="string" resultType="long">
        SELECT COUNT(*) FROM t_dm_dataset_files WHERE dataset_id = #{datasetId}
    </select>

    <select id="countCompletedByDatasetId" parameterType="string" resultType="long">
        SELECT COUNT(*) FROM t_dm_dataset_files WHERE dataset_id = #{datasetId} AND status = 'COMPLETED'
    </select>

    <select id="sumSizeByDatasetId" parameterType="string" resultType="long">
        SELECT COALESCE(SUM(file_size), 0) FROM t_dm_dataset_files WHERE dataset_id = #{datasetId}
    </select>

    <select id="findByDatasetIdAndFileName" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId} AND file_name = #{fileName}
        LIMIT 1
    </select>

    <select id="findAllByDatasetId" parameterType="string" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId}
        ORDER BY upload_time DESC
    </select>

    <select id="findByCriteria" resultMap="DatasetFileResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_dm_dataset_files
        WHERE dataset_id = #{datasetId}
        <!-- Replace invalid XML '&&' with 'and' for MyBatis OGNL -->
        <if test="fileType != null and fileType != ''">
            AND file_type = #{fileType}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY upload_time DESC
    </select>

    <insert id="insert" parameterType="com.dataengine.datamanagement.domain.model.dataset.DatasetFile">
        INSERT INTO t_dm_dataset_files (
            id, dataset_id, file_name, file_path, file_type, file_format, file_size, upload_time, last_access_time, status
        ) VALUES (
            #{id}, #{datasetId}, #{fileName}, #{filePath}, #{fileType}, #{fileFormat}, #{fileSize}, #{uploadTime}, #{lastAccessTime}, #{status}
        )
    </insert>

    <update id="update" parameterType="com.dataengine.datamanagement.domain.model.dataset.DatasetFile">
        UPDATE t_dm_dataset_files
        SET file_name = #{fileName},
            file_path = #{filePath},
            file_type = #{fileType},
            file_format = #{fileFormat},
            file_size = #{fileSize},
            upload_time = #{uploadTime},
            last_access_time = #{lastAccessTime},
            status = #{status}
        WHERE id = #{id}
    </update>

    <delete id="deleteById" parameterType="string">
        DELETE FROM t_dm_dataset_files WHERE id = #{id}
    </delete>
</mapper>
